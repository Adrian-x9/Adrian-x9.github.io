<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <title>Moja Biblioteka Poradników</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" sizes="16x16" href="./base-system/.gfx/favicons/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./base-system/.gfx/favicons/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./base-system/.gfx/favicons/apple-touch-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="./base-system/.gfx/favicons/android-icon-192x192.png" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* 8. Preloader Styles */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; animation: spin 1s linear infinite; }
        html:not(.dark-mode) #preloader { background-color: #e1e1e1; }
        html:not(.dark-mode) .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #cc0000; }
        html.dark-mode #preloader { background-color: #121212; }
        html.dark-mode .spinner { border: 5px solid #333; border-top: 5px solid #e53935; }
        #preloader.fade-out { opacity: 0; pointer-events: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        html:not(.dark-mode) { background-color: #e1e1e1; }
        html.dark-mode { background-color: #121212; }
        #bg-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; width: 100vw; height: 100vh; object-fit: cover; z-index: -1; display: none; }
        body.video-ready { background-color: transparent !important; }
        body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 20px; transition: background-color 0.5s ease, color 0.3s ease; min-height: 100vh; box-sizing: border-box; }
        body.no-animation .guide.animate-in, body.no-animation .guide.flip-animate { animation: none !important; transform: none !important; }
        body.no-animation .guide-cover, body.no-animation .top-header, body.no-animation .footer { transition: none !important; }
        body.play-mode-active > .top-header, body.play-mode-active > .controls,
        body.play-mode-active > .guide-list, body.play-mode-active > .pagination,
        body.play-mode-active > .footer { opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.4s ease, visibility 0s 0.4s; }
        #fileInput { display: none; }
        a { font-weight: bold; text-decoration: none; }
        a:hover { text-decoration: none; }
        .top-header a.dir-db-btn:hover { text-decoration: none; }
        .title-red { color: #cc0000; }
        .dark-mode .title-red { color: #e53935; }
        .dark-mode .version-suffix { color: #eee; }
        body:not(.dark-mode) .version-suffix { color: #333; }
        body:not(.dark-mode) .top-header .counter { color: #555; }
        .dark-mode .top-header .counter { color: #aaa; }
        body:not(.dark-mode) { color: #333; }
        body:not(.dark-mode) a { color: #cc0000; }
        body:not(.dark-mode) .dir-db-btn, body:not(.dark-mode) .highlighted-state { color: #cc0000; background: #fdfdfd; box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        body:not(.dark-mode) .dir-db-btn.highlighted-state { color: #fff; background: #cc0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.3), inset 0 1px 3px rgba(0,0,0,0.2); }
        body:not(.dark-mode) input, body:not(.dark-mode) select, body:not(.dark-mode) button { background-color: #fff; color: #333; border-color: #ccc; }
        body:not(.dark-mode) button:hover { background-color: #f0f0f0; }
        body:not(.dark-mode) .dir-db-btn:hover, body:not(.dark-mode) .highlighted-state:hover { box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); }
        body:not(.dark-mode) .guide { background: #fdfdfd; box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        body.video-ready:not(.dark-mode) .guide { background: rgba(253, 253, 253, 0.5); }
        body:not(.dark-mode) .guide-cover { border: 2px solid #cc0000; box-shadow: 0 0 10px rgba(204, 0, 0, 0.5); }
        body:not(.dark-mode) .pagination-info { background-color: #f0f0f0; border-color: #ddd; color: #555; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }
        body:not(.dark-mode) .footer { color: #666; }
        body:not(.dark-mode) .footer .footer-special-text { color: #555; }
        body:not(.dark-mode) .privacy-notice { color: #bbb; }
        .dark-mode { color: #eee; }
        .dark-mode a { color: #e53935; }
        .dark-mode .dir-db-btn, .dark-mode .highlighted-state { color: #e53935; background: #000; box-shadow: 0 0 20px rgba(255, 0, 0, 0.2); border: 1px solid #555; }
        .dark-mode .dir-db-btn.highlighted-state { color: #fff; background: #a01515; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4), inset 0 1px 3px rgba(0,0,0,0.3); }
        .dark-mode input, .dark-mode select, .dark-mode button { background-color: #000; color: #eee; border-color: #555; }
        .dark-mode button:hover:not(:disabled) { background-color: #222; }
        .dark-mode .dir-db-btn:hover, .dark-mode .highlighted-state:hover { background: #111; box-shadow: 0 0 25px rgba(255, 0, 0, 0.3); }
        .dark-mode .guide { background: #000; box-shadow: 0 0 20px rgba(255, 0, 0, 0.2); }
        body.video-ready.dark-mode .guide { background: rgba(0, 0, 0, 0.3); }
        .dark-mode .guide:hover { box-shadow: 0 0 25px rgba(255, 0, 0, 0.3); }
        .dark-mode .guide-info { color: #bbb; }
        .dark-mode .guide-cover { border: 2px solid #e53935; box-shadow: 0 0 10px rgba(229, 57, 53, 0.5); }
        .dark-mode .pagination-info { background-color: #222; border-color: #444; color: #ccc; box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.05); }
        .dark-mode .footer { color: #bbb; }
        .dark-mode .footer .footer-special-text { color: #eee; }
        .dark-mode .privacy-notice { color: #666; }
        button.inactive { font-weight: normal; opacity: 0.6; }
        .top-header { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; text-align: center; opacity: 0; transform: translateY(-20px); max-height: 200px; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out, opacity 0.5s ease-out, margin 0.5s ease-out; padding-top: 5px; }
        .top-header.minimized-header { max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important; opacity: 0; }
        .header-group { display: flex; gap: 10px; }
        .header-logo-group { display: flex; align-items: center; gap: 15px; }
        .header-logo-link { display: flex; align-items: center; perspective: 1000px; }
        .header-logo { max-height: 42px; width: auto; transition: transform 0.6s; transform-style: preserve-3d; }
        .top-header .title { font-size: 1.6em; font-weight: bold; }
        .top-header .counter { font-size: 0.9em; }
        .top-header .counter b { font-weight: bold; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; opacity: 0; transform: translateY(-20px); }
        input, select, button, .dir-db-btn { padding: 10px; border-radius: 5px; border: 1px solid; white-space: nowrap; }
        #search { width: 160px; }
        input::placeholder { color: #aaa; }
        .dark-mode input::placeholder { color: #666; }
        .dir-db-btn { padding: 10px 20px; border-radius: 10px; transition: background 0.3s, transform 0.2s, box-shadow 0.2s, color 0.3s; display: flex; align-items: center; font-weight: bold; font-size: 1em; cursor: pointer; }
        .dir-db-btn:hover { transform: translateY(-5px); }
        .dir-db-btn i { margin-right: 5px; }
        #minimizeBtn i, #langBtn i { margin-right: 0; }
        #langBtn { padding: 10px 12px; }
        .multi-button { padding: 0; overflow: hidden; /* 6. Button Animation */ transition: all 0.4s ease-in-out; }
        .multi-button > span { padding: 10px; display: inline-flex; align-items: center; justify-content: center; height: 100%; }
        .multi-button-main { flex-grow: 1; padding-right: 12px; }
        .multi-button-child { padding: 10px 12px; border-left: 1px solid rgba(0, 0, 0, 0.1); }
        .multi-button-child:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode .multi-button-child { border-left-color: rgba(255, 255, 255, 0.2); }
        .dark-mode .multi-button-child:hover { background-color: rgba(255,255,255,0.1); }
        .dir-db-btn.highlighted-state .multi-button-child { border-left-color: rgba(255, 255, 255, 0.5); }
        .dark-mode .dir-db-btn.highlighted-state .multi-button-child { border-left-color: rgba(255, 255, 255, 0.5); }
        .dir-db-btn.highlighted-state > .multi-button-main { position: relative; }
        .active-play i { color: #fff; text-shadow: 0 0 8px rgba(255, 255, 255, 0.9); }
        .dark-mode .active-play i { text-shadow: 0 0 10px #ff8a80; }
        .multi-button-child.active-play { background-color: rgba(0,0,0,0.1); }
        /* 2. Play Button Contrast */
        .multi-button-child.active-play { background-color: rgba(204,0,0,0.2); }
        .dark-mode .multi-button-child.active-play { background-color: rgba(229,57,53,0.3); }
        body:not(.dark-mode) .multi-button-child.active-play i { color: #cc0000; text-shadow: none; }
        body.dark-mode .multi-button-child.active-play i { color: #ff8a80; text-shadow: none; }
        #lightbox-controls .multi-button-child.active-play i,
        #lightbox-bg-video-controls button.active-play i { color: #e53935; text-shadow: none !important; }
        .dark-mode #lightbox-controls .multi-button-child.active-play i,
        .dark-mode #lightbox-bg-video-controls button.active-play i { color: #ff8a80; text-shadow: none !important; }
        .guide-list { display: grid; grid-template-columns: repeat(auto-fill, 250px); justify-content: center; gap: 20px; width: 90%; max-width: 1920px; margin: 0 auto; }
        .guide-list.random-draw { display: flex; justify-content: center; flex-wrap: wrap; }
        .guide-cover { max-width: 100%; height: auto; max-height: 300px; margin: 10px auto 0; display: block; border-radius: 5px; transition: opacity 0.5s, max-height 0.5s, margin 0.5s, padding 0.5s, border-width 0.5s, transform 0.5s ease-in-out; }
        .guide .guide-cover { opacity: 1; transform: scale(1); }
        .guide.animate-in .guide-cover { transition: none; opacity: 0; transform: scale(0.7); animation: fadeInCover 0.5s 0.1s ease-out forwards; }
        @keyframes fadeInCover { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }
        .guide-list.hide-covers .guide-cover { opacity: 0; max-height: 0; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border-width: 0; transform: scale(0.7); overflow: hidden; }
        .guide-title, .guide-info, .guide-content-bottom > a:not(.cover-link) { transition: opacity 0.5s, max-height 0.5s, margin 0.5s, padding 0.5s; overflow: hidden; }
        .guide-list.only-covers .guide-title, .guide-list.only-covers .guide-info, .guide-list.only-covers .guide-content-bottom > a:not(.cover-link) { opacity: 0; max-height: 0; margin: 0; padding: 0; pointer-events: none; }
        .guide-list.only-covers .guide { padding: 10px; justify-content: center; align-items: center; height: 100%; }
        .guide-list.only-covers .guide-cover { margin: 0; border: none !important; opacity: 1; transform: scale(1); }
        .guide { padding: 0 20px 10px; border-radius: 10px; transition: background 0.3s, transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between; text-align: center; width: 250px; box-sizing: border-box; }
        .guide:hover { transform: translateY(-5px); }
        .guide-content-bottom { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; }
        .guide-info-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .guide a { margin-top: 10px; display: inline-block; }
        .guide a.cover-link { margin-top: 0; display: block; }
        .guide-info { font-size: 0.9em; }
        .guide-title { margin-top: 7px; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; overflow-wrap: break-word; }
        .pagination { text-align: center; margin-top: 20px; margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; opacity: 0; transform: translateY(20px); }
        .pagination button, .pagination input, .pagination select { padding: 10px; margin: 0; font-size: 0.9em; cursor: pointer; border-radius: 5px; width: auto; }
        .pagination button:disabled { cursor: not-allowed; opacity: 0.5; }
        .guide.animate-in { animation: fadeInSlideIn 0.5s ease-out forwards; }
        .guide.fade-out { animation: fadeOutUp 0.2s forwards; pointer-events: none; }
        @keyframes fadeInSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .footer { text-align: center; padding: 20px; padding-top: 10px; font-size: 0.9em; opacity: 0; transform: translateY(20px); max-height: 200px; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out, opacity 0.5s ease-out, margin 0.5s ease-out; }
        .footer.minimized-footer { max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important; opacity: 0; }
        .nobr { white-space: nowrap; }
        .privacy-notice { margin-top: 10px; font-size: 0.9em; }
        .footer .footer-special-text { font-weight: normal; }
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.5s ease; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .dark-mode .backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .backdrop.visible { display: flex; opacity: 1; visibility: visible; }
        .play-guide-container { display: flex; justify-content: center; align-items: center; width: 90vw; height: 90vh; }
        .play-guide-container > a { max-width: 100%; max-height: 100%; display: flex; justify-content: center; align-items: center; }
        .play-guide-container .preview-media { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 5px; }
        .play-guide-container > a > img, .play-guide-container > a > video { max-width: 100%; max-height: 100%; display: block; object-fit: contain; border-radius: 5px; background-color: rgba(255, 255, 255, 0.67); box-shadow: 0 0 40px 5px rgba(0, 0, 0, 0.5); }
        body:not(.no-animation) .play-guide-container > a > img, body:not(.no-animation) .play-guide-container > a > video { animation: zoomInImage 0.5s ease-out; }
        .dark-mode .play-guide-container > a > img, .dark-mode .play-guide-container > a > video { background-color: rgba(0, 0, 0, 0.67); box-shadow: 0 0 50px 5px rgba(255, 255, 255, 0.35); }
        .play-caption { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 15px; border-radius: 5px; font-size: 1.2em; z-index: 1000; text-align: center; transition: opacity 0.3s ease; }
        body:not(.dark-mode) .play-caption { background-color: rgba(255, 255, 255, 0.9); color: #333; }
        .dark-mode .play-caption { background-color: rgba(0, 0, 0, 0.85); color: #ccc; }
        .caption-title-highlight { color: #e53935; font-weight: bold; }
        .caption-description { display: block; font-size: 0.8em; opacity: 0.7; font-weight: normal; margin-top: 5px; }
        
        .lightbox-action-btn { position: fixed; width: 44px; height: 44px; z-index: 1001; padding: 10px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5em; transition: background-color 0.2s ease, color 0.2s; }
        .lightbox-action-btn i { margin: 0; }
        #playCloseBtn { top: 15px; right: 15px; }
        #lightbox-minimizeBtn { bottom: 15px; right: 15px; }
        #lightbox-controls { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; transition: transform 0.4s ease; flex-wrap: wrap; z-index: 1000; }
        #lightbox-controls.minimized-controls { transform: translateY(100%); }
        .lightbox-control-group { display: flex; border-radius: 5px; overflow: hidden; }
        body:not(.dark-mode) .lightbox-control-group, body:not(.dark-mode) #lightbox-controls .dir-db-btn, body:not(.dark-mode) .lightbox-action-btn { background-color: rgba(255,255,255,0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .dark-mode .lightbox-control-group, .dark-mode #lightbox-controls .dir-db-btn, .dark-mode .lightbox-action-btn { background-color: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        #lightbox-controls button, #lightbox-controls .dir-db-btn, #lightbox-controls .multi-button-child, .lightbox-action-btn { background: none; border: none; cursor: pointer; padding: 10px 12px; transition: background-color 0.2s ease, color 0.2s; white-space: nowrap; }
        #lightbox-controls button, #lightbox-controls .multi-button-child { font-size: 1.5em; }
        #lightbox-controls button:hover, #lightbox-controls .dir-db-btn:hover, #lightbox-controls .multi-button-child:hover, .lightbox-action-btn:hover { background-color: rgba(0,0,0,0.1); color: #e53935; }
        .dark-mode #lightbox-controls button:hover, .dark-mode #lightbox-controls .dir-db-btn:hover, .dark-mode #lightbox-controls .multi-button-child:hover, .dark-mode .lightbox-action-btn:hover { background-color: rgba(255,255,255,0.15); }
        .lightbox-control-group button:not(:last-child), .lightbox-control-group span:not(:last-child) { border-right: 1px solid rgba(0,0,0,0.1); }
        .dark-mode .lightbox-control-group button:not(:last-child), .dark-mode .lightbox-control-group span:not(:last-child) { border-right-color: rgba(255,255,255,0.2); }
        #lightbox-controls .dir-db-btn { padding: 10px 12px; border-radius: 5px; font-size: 1.5em; }
        #lightbox-bg-video-controls { display: flex; max-width: 0; overflow: hidden; transition: max-width 0.4s ease-in-out; }
        #lightbox-bg-video-controls.visible { max-width: 500px; }

        @keyframes zoomInImage { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes zoomOutImage { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animated-header, .animated-controls, .animated-footer, .animated-pagination { animation-fill-mode: forwards; }
        .animated-header, .animated-controls { animation-name: fadeInDown; animation-duration: 0.6s; animation-timing-function: ease-out; }
        .animated-footer, .animated-pagination { animation-name: fadeInUp; animation-duration: 0.8s; animation-timing-function: ease-out; }
        .controls.minimized-view .btn-text, #lightbox-controls .btn-text { display: none; }
        .controls.minimized-view .dir-db-btn i, #lightbox-controls .dir-db-btn i { margin-right: 0; }
    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('visudir_theme');
                const defaultTheme = 'light';
                if ((theme === 'dark') || (!theme && defaultTheme === 'dark')) {
                    document.documentElement.classList.add('dark-mode');
                }
            } catch (e) { /* Ignore */ }
        })();
    </script>
</head>

<body>
    <div id="preloader">
        <div class="spinner"></div>
    </div>

    <video id="bg-video" autoplay loop muted playsinline>
        <source id="bg-video-source" src="" type="video/mp4" />
    </video>

    <div class="top-header">
        <div class="header-logo-group">
            <div id="guideCountDisplay" class="counter"><b>0</b> / 0 pozycji</div>
            <a id="logoLink" href="https://www.ade.pl" rel="noopener noreferrer" class="header-logo-link">
                <img id="header-logo" src="" alt="Logo" class="header-logo" />
            </a>
        </div>
        <div id="pageTitle" class="title">Poradniki do Gier</div>
        <div class="header-group">
            <a id="visuDirBtn" class="dir-db-btn" href="#">
                <span class="title-red">Visu</span><span class="version-suffix">Dir <span class="version-display"></span></span>
            </a>
            <a id="langBtn" class="dir-db-btn" href="index-en.html" title="Switch to English">
                <i class="fas fa-globe"></i>
            </a>
            <a id="backButton" class="dir-db-btn" href="javascript:history.back()"><i class="fas fa-chevron-left"></i>
                <span class="btn-text">Wstecz</span></a>
        </div>
    </div>

    <div class="controls">
        <label for="fileInput" id="fileInputLabel" class="dir-db-btn file-input-label"><i class="fas fa-upload"></i>
            <span class="btn-text">Załaduj...</span></label>
        <input type="file" id="fileInput" accept=".txt" />
        <button id="playButton" title="Losuj animacją" class="dir-db-btn">
            <i class="fas fa-play"></i><span class="btn-text"> Play</span>
        </button>
        <button onclick="resetView()" title="Resetuj widok" class="dir-db-btn">
            <i class="fas fa-sync"></i><span class="btn-text"> Reset</span>
        </button>
        <input type="text" id="search" placeholder="Szukaj pozycji..." />
        <select id="formatFilter">
            <option value="">Wszystko</option>
        </select>
        <select id="sortSelector">
            <option value="">Sortuj...</option>
            <option value="shuffle">Wymieszaj</option>
            <option value="nameAsc">Nazwa A–Z</option>
            <option value="nameDesc">Nazwa Z–A</option>
            <option value="dateAsc">Data ↑</option>
            <option value="dateDesc">Data ↓</option>
            <option value="sizeAsc">Rozmiar ↑</option>
            <option value="sizeDesc">Rozmiar ↓</option>
        </select>
        <select id="itemsPerPageSelector"></select>
        <select id="randomSelector">
            <option value="" disabled selected>Losuj...</option>
            <option value="1">Pozycje: 1</option>
            <option value="2">Pozycje: 2</option>
            <option value="3">Pozycje: 3</option>
            <option value="4">Pozycje: 4</option>
            <option value="5">Pozycje: 5</option>
            <option value="6">Pozycje: 6</option>
            <option value="7">Pozycje: 7</option>
            <option value="8">Pozycje: 8</option>
            <option value="9">Pozycje: 9</option>
            <option value="10">Pozycje: 10</option>
        </select>
        <div id="previewBtnGroup" class="dir-db-btn multi-button">
            <span id="previewBtn-main" class="multi-button-main"><i class="fas fa-object-group"></i><span class="btn-text"> Wszystko</span></span>
            <span id="previewBtn-vertical" class="multi-button-child" title="Pokaż pionowe"><i class="fas fa-arrows-alt-v"></i></span>
            <span id="previewBtn-horizontal" class="multi-button-child" title="Pokaż poziome"><i class="fas fa-arrows-alt-h"></i></span>
            <span id="previewBtn-reset" class="multi-button-child" title="Resetuj widok"><i class="fas fa-undo"></i></span>
        </div>
        <button id="animationBtn" class="dir-db-btn multi-button">
            <span id="animationBtn-main" class="multi-button-main"><i class="fas fa-video"></i><span class="btn-text"> Video</span></span>
            <span id="animationBtn-play" class="multi-button-child" title="Odtwarzaj / Pauza"><i class="fas fa-play"></i></span>
            <span id="animationBtn-shuffle" class="multi-button-child" title="Losowe wideo Wł/Wył"><i class="fas fa-random"></i></span>
            <span id="animationBtn-reset" class="multi-button-child" title="Resetuj ustawienia wideo"><i class="fas fa-undo"></i></span>
        </button>
        <button id="darkModeBtn" class="dir-db-btn"><i class="fas fa-moon"></i><span class="btn-text"> Tryb ciemny</span></button>
        <button id="minimizeBtn" class="dir-db-btn" title="Minimalizuj interfejs">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

    <div class="guide-list" id="guideList"></div>
    <div class="pagination" id="pagination"></div>

    <div class="footer">
        <div>
            <strong>System <a id="aboutLinkFooter" href="#"><span class="title-red">Visu</span><span class="version-suffix">Dir
                    <span class="version-display"></span></span></a></strong>
            <strong>© 2025-09-12</strong> do katalogowania, zarządzania i
            prezentacji plików i folderów |
            <span class="nobr"><a href="https://www.ade.pl" target="_blank" rel="noopener noreferrer">Adrian Ulbrych
                </a></span>
            <span class="nobr"><strong> tel.</strong> <a href="tel:601190330">601 190 330</a></span>
        </div>
        <div class="privacy-notice">
            <strong>Szanujemy Twoją prywatność</strong>. Żadnych ciasteczek ani
            śledzenia.
            <strong>Czysty i bezpieczny kod!</strong>
        </div>
    </div>

    <div id="backdrop" class="backdrop">
        <div id="play-caption" class="play-caption"></div>
        <button id="playCloseBtn" class="lightbox-action-btn"><i class="fas fa-times"></i></button>
        <div id="play-guide-container" class="play-guide-container"></div>
        
        <div id="lightbox-controls">
             <div class="lightbox-control-group">
                 <button id="lightbox-animationBtn" title="Przełącz animacje"><i class="fas fa-magic"></i></button>
                 <div id="lightbox-bg-video-controls">
                     <button id="lightbox-video-prev" title="Poprzednie wideo"><i class="fas fa-chevron-left"></i></button>
                     <button id="lightbox-video-toggle" title="Odtwarzaj / Pauza"><i class="fas fa-play"></i></button>
                     <button id="lightbox-video-autoshuffle" title="Automatyczne losowanie wideo Wł/Wył"><i class="fas fa-random"></i></button>
                     <button id="lightbox-video-next" title="Następne wideo"><i class="fas fa-chevron-right"></i></button>
                </div>
             </div>

            <div id="slideshow-controls" class="lightbox-control-group">
                <span id="slideshow-first" class="multi-button-child" title="Pierwszy"><i class="fas fa-fast-backward"></i></span>
                <span id="slideshow-prev" class="multi-button-child" title="Poprzedni"><i class="fas fa-step-backward"></i></span>
                <span id="slideshow-stop" class="multi-button-child" title="Zatrzymaj"><i class="fas fa-stop"></i></span>
                <span id="slideshow-play" class="multi-button-child" title="Play/Pauza"><i class="fas fa-play"></i></span>
                <span id="slideshow-shuffle" class="multi-button-child" title="Losowe slajdy Wł/Wył"><i class="fas fa-random"></i></span>
                <span id="slideshow-next" class="multi-button-child" title="Następny"><i class="fas fa-step-forward"></i></span>
                <span id="slideshow-last" class="multi-button-child" title="Ostatni"><i class="fas fa-fast-forward"></i></span>
            </div>

            <button id="lightbox-darkModeBtn" class="dir-db-btn" title="Tryb ciemny/jasny"><i class="fas fa-moon"></i></button>
        </div>
        <button id="lightbox-minimizeBtn" class="lightbox-action-btn" title="Minimalizuj interfejs"><i class="fas fa-chevron-down"></i></button>
    </div>

    <script>
        // --- KONFIGURACJA ---
        const config = {
            version: 'v1.2.9', // Updated version
            global: {
                defaultTheme: 'light',
            },
            logoRotator: {
                enabled: true,
                interval: 4500,
                logos: [
                    { srcLight: "base-system/gfx/interface/VisuDir_small_light.png", srcDark: "base-system/gfx/interface/VisuDir_small_dark.png", href: "base-system/about.html", alt: "Logo VisuDir" },
                    { srcLight: "base-system/gfx/interface/ADE_small_light.png", srcDark: "base-system/gfx/interface/ADE_small_dark.png", href: "https://www.ade.pl", alt: "Logo ADE" }
                ]
            },
            pageSettings: {
                pageKey: 'indexMaxi',
                pageTitle: "START ▪ maxi MENU ▪",
                showMiniLogo: true,
                showVisuDirButton: true,
                showBackButton: false,
                showLanguageButton: true, // 1. Added Language Button Config
                defaultBgVideo: 18,
                bgVideoStartNum: 1,
                bgVideoEndNum: 18,
                defaultAnimation: 2,
                defaultView: 2,
                defaultFormat: "LINK",
                defaultSort: "nameAsc",
                defaultRows: 2,
                predefinedFilters: [
                    { label: "ADE", search: "ade" },
                    { label: "E-booki", search: "e-booki" },
                    { label: "Galerie", search: "galerie" },
                    { label: "Hiszpania", search: "hiszpania" },
                    { label: "Niemcy", search: "niemcy" },
                    { label: "Polska", search: "polska" },
                    { label: "Poradniki", search: "poradniki" },
                ],
            }, 
            paths: {
                url404: "base-system/404.html",
                urlAbout: "base-system/about.html",
                urlFallback: "base-system/soon.html", // 10. Added Fallback URL Config
                databaseFileName: "base-system/db.txt",
                dataFolderName: "base-system/files",
                coversFolderName: "base-system/preview",
                previewHdFolderName: "base-system/preview-hd",
                videoBgLightUrlBase: "base-system/video/bg_light",
                videoBgDarkUrlBase: "base-system/video/bg_dark",
            }
        };
        // --- KONIEC KONFIGURACJI ---

        // --- PLIKOWA BAZA DANYCH ---
        const dataFromFile = `
12.09.2025  10:15                 0 .#base-system#contact.html$$04 Kontakt$$Kontakt z autorem - Adrianem Ulbrych.link
12.09.2025  10:10                 0 .#base-system#cv.html$$06 Moje CV$$Adrian Ulbrych - moje CV.link
12.09.2025  09:53                 0 .#base-system#soon.html&&title=AI$$08 AI$$Sztuczna inteligencja - newsy i informacje.link
12.09.2025  10:08                 0 .#base-system#soon.html&&title=autor$$03 Autor$$Adrian Ulbrych - informacje o autorze.link
12.09.2025  10:15                 0 .#base-system#soon.html&&title=Kopia Zapasowa$$09 ADE Kopia zapasowa$$Autorskie narzedzia do kopii zapasowych.link
12.09.2025  10:18                 0 .#base-system#soon.html&&title=Kopia Zapasowa$$09 ADE Kopia zapasowa$$Autorskie narzedzia do kopii zapasowych.llink
12.09.2025  10:19                 0 .#base-system#soon.html&&title=Panel poczty$$11 ADE Poczta e-mail$$Panel dostepu do poczty e-mail.link
12.09.2025  10:51                 0 .#base-system#soon.html&&title=Praca zdalna$$10 ADE Zdalny dostep$$Autorskie narzedzia do pracy zdalnej.link
12.09.2025  10:09                 0 .#Certyfikaty#index.html$$13 Certyfikaty$$Adrian Ulbrych - certyfikaty.link
12.09.2025  10:11                 0 .#Dortmund#index.html$$19 Dortmund Niemcy$$Dortmund - galeria zdjec.link
12.09.2025  10:12                 0 .#e-booki#index.html$$23 e-booki$$e-booki - przykladowa kolekcja.link
12.09.2025  10:13                 0 .#Hiszpania#index.html$$20 Hiszpania$$Hiszpania - galeria zdjec.link
12.09.2025  10:48                 0 .#Hiszpania#index.html&&Barcelona$$22 Barcelona Hiszpania$$Barcelona - galeria zdjec.link
12.09.2025  10:16                 0 .#Hiszpania#index.html&&lloret$$21 Lloret de Mar Hiszpania$$Lloret de Mar - galeria zdjec.link
12.09.2025  10:17                 0 .#index.html$$02 mini MENU$$Otworz standardowe MENU.link
12.09.2025  10:19                 0 .#Niemcy#index.html$$18 Niemcy$$Niemcy - galeria zdjec.link
12.09.2025  10:20                 0 .#Polska#index.html$$14 Polska$$Polska - galeria zdjec.link
12.09.2025  10:12                 0 .#Polska#index.html&&search=gliwice$$15 Gliwice Polska$$Gliwice - galeria zdjec.link
12.09.2025  10:18                 0 .#Polska#index.html&&search=morze$$17 Morze Baltyckie Polska$$Morze Baltyckie - galeria zdjec.link
12.09.2025  10:50                 0 .#Polska#index.html&&search=warszawa$$16 Warszawa Polska$$Warszawa - galeria zdjec.link
12.09.2025  10:48                 0 .#Poradniki#index.html$$24 Poradniki do Gier$$Wszystkie poradniki do gier.link
12.09.2025  10:49                 0 .#Poradniki#index.html&&search=gry-online$$25 Poradniki Gry-Online$$Poradniki ze strony Gry-Online.pl.link
12.09.2025  10:14                 0 .#Poradniki#index.html&&search=instr$$27 Instrukcje do Gier$$Instrukcje ze Steam, Epic i inne.link
12.09.2025  10:50                 0 .#Poradniki#index.html&&search=mania$$26 Poradniki PrzygodoMania$$Darmowe poradniki ze strony PrzygodoMania.pl.link
12.09.2025  10:50                 0 .#VisuKeys#index.html$$07 VisuKeys$$Autorski projekt - w budowie.link
        `;
        // --- KONIEC BAZY DANYCH ---

        let guides = [],
            filteredGuides = [],
            playGuidesQueue = [];
        let currentPage = 1,
            itemsPerPage;
        let playAnimationTimeout = null, slideshowIsPlaying = false, slideshowIsRandom = false,
            currentSort,
            selectedRowCount;
        let playCurrentIndex = 0,
            itemsPerRow = 0;
        let animationState, previewState, orientationFilterState = null;
        let lastPlayedGuide = null, lastRandomPage = -1;
        let currentLogoIndex = 0;
        let logoInterval, autoShuffleInterval = null;
        let isMinimized = false, isLightboxMinimized = false;
        let guideDimensionsCache = {};


        const fileInput = document.getElementById("fileInput"),
            fileInputLabel = document.getElementById("fileInputLabel"),
            searchInput = document.getElementById("search"),
            formatFilter = document.getElementById("formatFilter"),
            guideList = document.getElementById("guideList"),
            pagination = document.getElementById("pagination"),
            darkModeBtn = document.getElementById("darkModeBtn"),
            previewBtnGroup = document.getElementById("previewBtnGroup"),
            previewBtnMain = document.getElementById("previewBtn-main"),
            animationBtn = document.getElementById("animationBtn"),
            sortSelector = document.getElementById("sortSelector"),
            itemsPerPageSelector = document.getElementById("itemsPerPageSelector"),
            randomSelector = document.getElementById("randomSelector"),
            playButton = document.getElementById("playButton"),
            backdrop = document.getElementById("backdrop"),
            playGuideContainer = document.getElementById("play-guide-container"),
            playCaption = document.getElementById("play-caption"),
            playCloseBtn = document.getElementById("playCloseBtn"),
            lightboxControls = document.getElementById("lightbox-controls"),
            lightboxVideoToggle = document.getElementById("lightbox-video-toggle"),
            lightboxVideoAutoshuffle = document.getElementById('lightbox-video-autoshuffle'),
            slideshowPlayBtn = document.getElementById("slideshow-play"),
            headerLogo = document.getElementById("header-logo"),
            logoLink = document.getElementById("logoLink"), 
            bgVideo = document.getElementById("bg-video"),
            bgVideoSource = document.getElementById("bg-video-source");

        function initializeTheme() {
            const storedTheme = localStorage.getItem('visudir_theme');
            const theme = storedTheme || config.global.defaultTheme;
            const isDark = theme === 'dark';

            document.documentElement.classList.toggle('dark-mode', isDark);
            document.body.className = document.documentElement.className;
            
            if (!storedTheme) {
                localStorage.setItem('visudir_theme', theme);
            }
            updateDarkModeButtonUI();
            return theme;
        }

        function updateDarkModeButtonUI() {
            const isDark = document.documentElement.classList.contains('dark-mode');
            const btnIcon = darkModeBtn.querySelector('i');
            const btnText = darkModeBtn.querySelector('.btn-text');
            const lightboxBtnIcon = document.getElementById('lightbox-darkModeBtn').querySelector('i');

            if (isDark) {
                if (btnIcon) btnIcon.className = 'fas fa-sun';
                if (lightboxBtnIcon) lightboxBtnIcon.className = 'fas fa-sun';
                if (btnText) btnText.textContent = ' Tryb jasny';
            } else {
                if (btnIcon) btnIcon.className = 'fas fa-moon';
                if (lightboxBtnIcon) lightboxBtnIcon.className = 'fas fa-moon';
                if (btnText) btnText.textContent = ' Tryb ciemny';
            }
        }

        function initializeBackgroundVideo(theme) {
            const pageKey = config.pageSettings.pageKey;
            const storageKey = `visudir_bg_video_${pageKey}`;
            const storedVideoNum = localStorage.getItem(storageKey);
            let videoNum = parseInt(storedVideoNum) || config.pageSettings.defaultBgVideo;

            if (videoNum < config.pageSettings.bgVideoStartNum || videoNum > config.pageSettings.bgVideoEndNum) {
                videoNum = config.pageSettings.defaultBgVideo;
            }

            if (bgVideo && bgVideoSource) {
                const videoUrlBase = theme === 'light' ? config.paths.videoBgLightUrlBase : config.paths.videoBgDarkUrlBase;
                const videoSrc = `${videoUrlBase}${videoNum}.mp4`;
                bgVideoSource.src = videoSrc;
                bgVideo.load();
                bgVideo.addEventListener("canplay", () => document.body.classList.add("video-ready"), { once: true });
            }

            if (!storedVideoNum || parseInt(storedVideoNum) !== videoNum) {
                localStorage.setItem(storageKey, videoNum);
            }
        }
        
        function updateBackgroundVideoVisibility() {
            const isVideoVisible = animationState === 2;
             if (isVideoVisible) {
                bgVideo.style.display = 'block';
                initializeBackgroundVideo(currentTheme);
            } else {
                bgVideo.style.display = 'none';
                document.body.classList.remove('video-ready');
            }
        }
        
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(`visudir_${key}`, value);
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        }

        function getFromLocalStorage(key) {
            try {
                return localStorage.getItem(`visudir_${key}`);
            } catch (e) {
                console.error("Error reading from localStorage", e);
                return null;
            }
        }

        function loadConfig() {
            currentSort = getFromLocalStorage('sort') || config.pageSettings.defaultSort;
            selectedRowCount = parseInt(getFromLocalStorage('rows')) || config.pageSettings.defaultRows;
            const storedAnimation = getFromLocalStorage(`animation_${config.pageSettings.pageKey}`);
            animationState = storedAnimation !== null ? parseInt(storedAnimation, 10) : config.pageSettings.defaultAnimation;

            const storedView = getFromLocalStorage('view');
            previewState = storedView !== null ? parseInt(storedView, 10) : config.pageSettings.defaultView;
        }

        function getFileExtension(filename) {
            return filename.slice(((filename.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();
        }
        function normalizeUrl(url) {
            const trimmedUrl = url.trim();
            if (trimmedUrl.startsWith('http://') || trimmedUrl.startsWith('https://') || trimmedUrl.startsWith('./') || trimmedUrl.startsWith('../') || trimmedUrl.startsWith('/')) {
                return trimmedUrl;
            }
            return `https://${trimmedUrl}`;
        }
        function decodeUrlFromFilename(filename) {
            let urlPart = filename.split('$$')[0];
            urlPart = urlPart.replace(/\.link$/i, '');
            urlPart = urlPart.replace(/#/g, '/');
            urlPart = urlPart.replace(/&&/g, '?');
            return normalizeUrl(urlPart);
        }
        function parseGuideTitle(filename) {
             // 5. Video File Support
            const baseName = filename.replace(/\.(pdf|epub|mobi|link|jpg|png|mp4|avi)$/i, '').trim();
            const parts = baseName.split('$$');

            if (getFileExtension(filename) === 'link' && parts.length > 1) {
                return {
                    title: decodeURIComponent(parts[1] || ''),
                    offlineDesc: decodeURIComponent(parts[2] || null)
                };
            }

            const title = decodeURIComponent(parts[0].replace(/_/g, ' ').replace(/-/g, ' ')).replace(/\s*-\s*Poradnik(?:_do_gry)?\s*(?:GRY-OnLine|Gry-OnLine)?\s*/i, '').trim();
            return { title: title, offlineDesc: null };
        }
        function createDateFromStrings(dateStr, timeStr) {
            const [day, month, year] = dateStr.split('.').map(Number);
            const [hours, minutes] = timeStr.split(':').map(Number);
            return new Date(year, month - 1, day, hours, minutes);
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function applySort(sortType, array) {
            currentSort = sortType;
            switch (sortType) {
                case "shuffle":
                    shuffleArray(array);
                    break;
                case "nameAsc":
                    array.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case "nameDesc":
                    array.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case "dateAsc":
                    array.sort((a, b) => a.timestamp - b.timestamp);
                    break;
                case "dateDesc":
                    array.sort((a, b) => b.timestamp - a.timestamp);
                    break;
                case "sizeAsc":
                    array.sort((a, b) => parseFloat(a.sizeMB) - parseFloat(b.sizeMB));
                    break;
                case "sizeDesc":
                    array.sort((a, b) => parseFloat(b.sizeMB) - parseFloat(a.sizeMB));
                    break;
            }
        }

        function getGuideOrientation(guide) {
            return new Promise((resolve) => {
                const f = guide.file.replace(/\.(pdf|epub|mobi|link|jpg|png|mp4|avi)$/i, "").split("$$")[0];
                const coverUrl = `${config.paths.coversFolderName}/${encodeURIComponent(f)}.jpg`;

                if (guideDimensionsCache[coverUrl]) {
                    guide.orientation = guideDimensionsCache[coverUrl];
                    resolve();
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    guide.orientation = (img.naturalHeight > img.naturalWidth) ? 'vertical' : 'horizontal';
                    guideDimensionsCache[coverUrl] = guide.orientation;
                    resolve();
                };
                img.onerror = () => {
                    guide.orientation = 'unknown';
                    guideDimensionsCache[coverUrl] = 'unknown';
                    resolve();
                };
                img.src = coverUrl;
            });
        }

        async function processData(text) {
            const lines = text.split(/\r?\n/);
            guides = [];
            for (const line of lines) {
                const match = line.match(/^(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2})\s+((?:<DIR>)|\d+)\s+(.+)$/i);
                if (match) {
                    const date = match[1];
                    const time = match[2];
                    const sizeOrDir = match[3];
                    const filename = match[4];
                    const format = getFileExtension(filename);

                    let sizeBytes = 0;
                    if (sizeOrDir !== '<DIR>') {
                        sizeBytes = parseInt(sizeOrDir);
                    }

                    if (sizeBytes === 0 && format !== 'link') continue;

                    const sizeMB = (sizeBytes / (1024 * 1024)).toFixed(2);
                    const { title, offlineDesc } = parseGuideTitle(filename);
                    let linkData = { description: offlineDesc };

                    if (format === 'link' && location.protocol !== 'file:') {
                        try {
                            const response = await fetch(`${config.paths.dataFolderName}/${filename}`);
                            if (response.ok) {
                                linkData.description = await response.text();
                            } else if (!offlineDesc) {
                                linkData.description = 'Błąd wczytywania opisu.';
                            }
                        } catch (e) {
                            if (!offlineDesc) linkData.description = 'Błąd wczytywania opisu.';
                        }
                    }
                    guides.push({
                        title,
                        format,
                        file: filename,
                        sizeMB,
                        date,
                        time,
                        timestamp: createDateFromStrings(date, time).getTime(),
                        linkData,
                        orientation: 'pending'
                    });
                }
            }
            
            const orientationPromises = guides
                .filter(guide => ['jpg', 'png', 'link', 'mp4', 'avi'].includes(guide.format))
                .map(guide => getGuideOrientation(guide));

            await Promise.all(orientationPromises);
        }

        function updateFormatFilter() {
            const formats = [...new Set(guides.map(g => g.format.toUpperCase()))].sort();
            formatFilter.innerHTML = '<option value="">Wszystko</option>';
            formats.forEach(t => {
                const o = document.createElement("option");
                o.value = t.toLowerCase();
                o.textContent = t;
                formatFilter.appendChild(o);
            });
            if (config.pageSettings.predefinedFilters.some(p => p.label && p.search)) {
                const s = document.createElement("option");
                s.disabled = true;
                s.textContent = "──────────";
                formatFilter.appendChild(s);
            }
            config.pageSettings.predefinedFilters.forEach(p => {
                if (p.label && p.search) {
                    const o = document.createElement("option");
                    o.value = `search:${p.search}`;
                    o.textContent = p.label;
                    formatFilter.appendChild(o);
                }
            });
        }

        function updatePaginationOptions() {
            const oldItemsPerPage = itemsPerPage;
            const guideWidth = 250,
                guideGap = 20;
            itemsPerRow = Math.max(
                1,
                Math.floor(guideList.clientWidth / (guideWidth + guideGap))
            );
            itemsPerPageSelector.innerHTML = `<option value="" disabled>Wiersze...</option>`;
            const totalItems = filteredGuides.length;
            const totalRowsAvailable =
                totalItems > 0 ? Math.ceil(totalItems / itemsPerRow) : 0;
            const rowOptions = [1, 2, 3, 4, 5, 10, 20, 50, 100, 1000];
            rowOptions.forEach((rows) => {
                if (totalRowsAvailable > 0 && rows > totalRowsAvailable) return;
                const option = document.createElement("option");
                option.value = rows;
                option.textContent = `Wierszy: ${rows}`;
                itemsPerPageSelector.appendChild(option);
            });
            
            const validOption = itemsPerPageSelector.querySelector(`option[value="${selectedRowCount}"]`);
            if (validOption) {
                itemsPerPageSelector.value = selectedRowCount;
            } else {
                 itemsPerPageSelector.selectedIndex = 0;
            }

            if (itemsPerPageSelector.value) {
                selectedRowCount = parseInt(itemsPerPageSelector.value);
            } else {
                selectedRowCount = config.pageSettings.defaultRows;
            }
            
            itemsPerPage = selectedRowCount * itemsPerRow;

            if (oldItemsPerPage !== itemsPerPage && guides.length > 0) {
                const firstItemIndex =
                    (currentPage - 1) * (oldItemsPerPage || itemsPerPage);
                currentPage = Math.max(
                    1,
                    Math.floor(firstItemIndex / itemsPerPage) + 1
                );
                renderGuides();
            }
        }

        function loadAndParseFile(file) {
            const r = new FileReader();
            r.onload = (e) => init(e.target.result);
            r.readAsText(file, "utf-8");
            fileInput.value = null;
        }
        
        function applyFilters() {
            const search = searchInput.value.toLowerCase();
            const formatValue = formatFilter.value;
            let format = formatValue;

            if (formatValue.startsWith("search:")) {
                search = formatValue.substring(7).toLowerCase();
                format = "";
            }

            filteredGuides = guides.filter(g => {
                const inTitle = g.title.toLowerCase().includes(search);
                // 4. Enhanced Search
                const inDescription = g.linkData.description && g.linkData.description.toLowerCase().includes(search);
                const searchMatch = inTitle || inDescription;

                const formatMatch = !format || g.format === format;
                const orientationMatch = !orientationFilterState || g.orientation === orientationFilterState;

                return searchMatch && formatMatch && orientationMatch;
            });
        }


        async function init(data) {
            fileInputLabel.style.display = "none";
            await processData(data);
            updateFormatFilter();
            applySort(currentSort, guides);

            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search');
            if (searchQuery) {
                searchInput.value = decodeURIComponent(searchQuery);
            }
            
            const defaultFormat = config.pageSettings.defaultFormat || "";
            formatFilter.value = (getFromLocalStorage('format') || defaultFormat).toLowerCase();
            
            applyFilters();
            updatePaginationOptions();
            renderGuides();
            
            // 8. Hide preloader
            const preloader = document.getElementById('preloader');
            if (preloader) {
                preloader.classList.add('fade-out');
            }
        }

        function startLogoRotator() {
            const initialLogo = config.logoRotator.logos[currentLogoIndex];
            if (!initialLogo) return;
            const isDark = document.documentElement.classList.contains('dark-mode');
            headerLogo.src = isDark ? initialLogo.srcDark : initialLogo.srcLight;
            logoLink.href = initialLogo.href;
            headerLogo.alt = initialLogo.alt;

            if (!config.logoRotator || !config.logoRotator.enabled || config.logoRotator.logos.length < 2) {
                return;
            }

            clearInterval(logoInterval);
            logoInterval = setInterval(() => {
                headerLogo.style.transform = 'rotateY(90deg)';
                setTimeout(() => {
                    currentLogoIndex = (currentLogoIndex + 1) % config.logoRotator.logos.length;
                    const newLogo = config.logoRotator.logos[currentLogoIndex];
                    const isDarkNow = document.documentElement.classList.contains('dark-mode');
                    
                    headerLogo.src = isDarkNow ? newLogo.srcDark : newLogo.srcLight;
                    headerLogo.alt = newLogo.alt;
                    logoLink.href = newLogo.href;

                    headerLogo.style.transform = 'rotateY(0deg)';
                }, 300);
            }, config.logoRotator.interval);
        }

        window.onload = function () {
            fileInputLabel.style.display = "none";
            document.querySelectorAll('.version-display').forEach(el => el.textContent = config.version);
            document.getElementById("pageTitle").textContent = config.pageSettings.pageTitle;
            document.title = config.pageSettings.pageTitle;
            document.getElementById("aboutLinkFooter").href = config.paths.urlAbout;
            document.getElementById("visuDirBtn").href = config.paths.urlAbout;

            currentTheme = initializeTheme();
            
            if (config.pageSettings.showMiniLogo) {
                startLogoRotator();
            } else {
                 document.getElementById("logoLink").style.display = "none";
            }
            
            // 1. Language Button Visibility
            if (!config.pageSettings.showLanguageButton) document.getElementById("langBtn").style.display = "none";
            if (!config.pageSettings.showVisuDirButton) document.getElementById("visuDirBtn").style.display = "none";
            document.getElementById("backButton").style.display = config.pageSettings.showBackButton ? "flex" : "none";

            loadConfig();
            updateAnimationButtonUI();
            updatePreviewButtonUI();
            updateBackgroundVideoVisibility();

            document.getElementById('minimizeBtn').addEventListener('click', toggleMinimizeView);
            document.getElementById('lightbox-minimizeBtn').addEventListener('click', toggleLightboxMinimize);
            darkModeBtn.addEventListener('click', toggleDarkMode);
            
            animationBtn.addEventListener('click', (event) => {
                const target = event.target.closest('span');
                if (!target) return;

                if (target.id === 'animationBtn-shuffle') {
                    toggleAutoShuffle();
                } else if (target.id === 'animationBtn-play') {
                    toggleBackgroundVideoPlayback();
                } else if (target.id === 'animationBtn-reset') {
                    resetVideoSettings();
                } else {
                    toggleAnimations();
                }
            });
            
            previewBtnGroup.addEventListener('click', (event) => {
                const target = event.target.closest('span');
                 if (!target) return;

                // 9. Orientation Filters
                if(target.id === 'previewBtn-vertical') {
                    orientationFilterState = orientationFilterState === 'vertical' ? null : 'vertical';
                    if (previewState === 0) { previewState = 2; }
                    renderGuides();
                } else if(target.id === 'previewBtn-horizontal') {
                    orientationFilterState = orientationFilterState === 'horizontal' ? null : 'horizontal';
                    if (previewState === 0) { previewState = 2; }
                    renderGuides();
                } else if(target.id === 'previewBtn-reset') {
                    resetPreview();
                } else {
                    togglePreview();
                }
            });

            if (dataFromFile && dataFromFile.trim().length > 0) {
                init(dataFromFile);
            } else {
                fetch(config.paths.databaseFileName)
                    .then((r) => (r.ok ? r.text() : Promise.reject(r.statusText)))
                    .then((t) => init(t))
                    .catch((e) => {
                        console.error(`Automatyczne ładowanie pliku '${config.paths.databaseFileName}' nie powiodło się. Błąd:`, e);
                        fileInputLabel.style.display = "flex";
                        const preloader = document.getElementById('preloader');
                        if (preloader) {
                            preloader.classList.add('fade-out');
                        }
                    });
            }
        };
        
        function toggleMinimizeView() {
            const topHeader = document.querySelector('.top-header');
            const footer = document.querySelector('.footer');
            const controls = document.querySelector('.controls');
            const minimizeBtn = document.getElementById('minimizeBtn');
            const minimizeIcon = minimizeBtn.querySelector('i');

            isMinimized = !isMinimized;
            controls.classList.toggle('minimized-view', isMinimized);
            
            minimizeBtn.title = isMinimized ? "Przywróć interfejs" : "Minimalizuj interfejs";
            minimizeIcon.className = isMinimized ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            
            topHeader.classList.toggle('minimized-header', isMinimized);
            footer.classList.toggle('minimized-footer', isMinimized);
        }
        
        function toggleLightboxMinimize() {
            const minimizeBtn = document.getElementById('lightbox-minimizeBtn');
            const minimizeIcon = minimizeBtn.querySelector('i');
            isLightboxMinimized = !isLightboxMinimized;
            
            lightboxControls.classList.toggle('minimized-controls', isLightboxMinimized);
            playCaption.style.opacity = isLightboxMinimized ? '0' : '1';
            minimizeBtn.title = isLightboxMinimized ? "Przywróć interfejs" : "Minimalizuj interfejs";
            minimizeIcon.className = isLightboxMinimized ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }

        function resetView() {
            stopPlayAnimation();
            searchInput.value = "";
            formatFilter.value = (config.pageSettings.defaultFormat || "").toLowerCase();
            saveToLocalStorage('format', formatFilter.value);
            sortSelector.value = "";
            applySort(config.pageSettings.defaultSort, guides);
            saveToLocalStorage('sort', config.pageSettings.defaultSort);
            currentPage = 1;
            selectedRowCount = config.pageSettings.defaultRows;
            saveToLocalStorage('rows', selectedRowCount);
            resetPreview();
        }
        
        // 10. File Existence Check function
        function checkFileAndOpen(fileUrl, fallbackUrl) {
            const http = new XMLHttpRequest();
            http.open('HEAD', fileUrl, true);
            http.timeout = 2000; // 2 seconds timeout
            http.onload = function() {
                if (this.status === 200 || this.status === 0) { // status 0 for local files
                    window.open(fileUrl, '_blank');
                } else {
                    window.open(fallbackUrl, '_self');
                }
            };
            http.onerror = http.ontimeout = function() {
                window.open(fallbackUrl, '_self');
            };
            http.send();
        }

        function createGuideHtml(guide) {
            const f = guide.file.replace(/\.(pdf|epub|mobi|link|jpg|png|mp4|avi)$/i, "").split("$$")[0],
                u = `${config.paths.dataFolderName}/${encodeURIComponent(guide.file)}`,
                c = `${config.paths.coversFolderName}/${encodeURIComponent(f)}.jpg`;
            let h = "", i = "", a = "", w = "";
            let d = guide.title;
            if (guide.format === "link" && /^\d{2}\s*/.test(d))
                d = d.replace(/^\d{2}\s*/, "");
            
            if (guide.format === "link") {
                const t = decodeUrlFromFilename(guide.file),
                    g = t.startsWith(".") || t.startsWith("/") ? "" : 'target="_blank" rel="noopener noreferrer"';
                h = `<div class="guide-title"><a href="${t}" ${g}>${d}</a></div>`;
                i = `<div class="guide-info">${guide.linkData.description || ""}</div>`;
                a = `<a href="${t}" ${g}><i class="fas fa-external-link-alt"></i> Otwórz</a>`;
                w = `<a href="${t}" ${g} class="cover-link">`;
            } else {
                h = `<div class="guide-title">${d}</div>`;
                i = `<div class="guide-info"><i class="fas fa-calendar-alt"></i> ${guide.date} ${guide.time}<br><i class="fas fa-file-alt"></i> Format: ${guide.format.toUpperCase()}<br><i class="fas fa-database"></i> Rozmiar: ${guide.sizeMB} MB</div>`;
                
                // 5. Video File Support
                if (["jpg", "png", "mp4", "avi"].includes(guide.format)) {
                    a = `<a href="#" onclick="showMediaPreview('${guide.file.replace(/'/g, "\\'")}'); return false;"><i class="fas fa-eye"></i> Otwórz</a>`;
                    w = `<a href="#" onclick="showMediaPreview('${guide.file.replace(/'/g, "\\'")}'); return false;" class="cover-link">`;
                } else {
                    const isPdf = guide.format === "pdf";
                    if (isPdf) {
                        // 10. Use fallback for PDFs
                        a = `<a href="${u}" onclick="checkFileAndOpen('${u}', '${config.paths.urlFallback}'); return false;"><i class="fas fa-file-pdf"></i> Otwórz</a>`;
                        w = `<a href="#" onclick="checkFileAndOpen('${u}', '${config.paths.urlFallback}'); return false;" class="cover-link">`;
                    } else { // Download for other formats like epub, mobi etc.
                        a = `<a href="${u}" download><i class="fas fa-download"></i> Pobierz</a>`;
                        w = `<a href="${u}" download class="cover-link">`;
                    }
                }
            }
            const k = document.documentElement.classList.contains("dark-mode") ? "base-system/gfx/no_cover_dark.png" : "base-system/gfx/no_cover_light.png";
            return `${h}<div class="guide-content-bottom"><div class="guide-info-container">${i}</div>${w}<img src="${c}" alt="Okładka: ${d}" class="guide-cover" onerror="this.onerror=null;this.src='${k}';this.classList.add('placeholder-cover');this.style.opacity=1;this.style.transform='scale(1)';"></a>${a}</div>`;
        }

        function renderGuides() {
            guideList.innerHTML = "";
            applyFilters();
            
            const totalPages = Math.ceil(filteredGuides.length / itemsPerPage);
            currentPage = Math.min(currentPage, totalPages || 1);
            const pageItems = filteredGuides.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );
            
            const animationsOn = animationState !== 0;

            pageItems.forEach((guide, index) => {
                const div = document.createElement("div");
                div.className = "guide";
                guideList.appendChild(div);
                div.innerHTML = createGuideHtml(guide);
                
                if (animationsOn) {
                    div.style.opacity = 0;
                     setTimeout(() => {
                        div.classList.add("animate-in");
                        div.style.animationDelay = `${index * 0.05}s`;
                    }, 20);
                }
            });
            updatePreviewButtonUI();
            renderPagination(totalPages);
            document.getElementById("guideCountDisplay").innerHTML = `<b>${filteredGuides.length}</b> / ${guides.length} pozycji`;
        }
        function renderPagination(totalPages) {
            pagination.innerHTML = "";
            if (totalPages <= 1) return;
            const container = document.createElement("div");
            container.style.cssText = "display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:10px;";
            const createBtn = (html, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.innerHTML = html;
                btn.disabled = disabled;
                btn.onclick = () => {
                    onClick();
                    renderGuides();
                    stopPlayAnimation();
                };
                return btn;
            };
            container.appendChild(
                createBtn(`<i class="fas fa-angle-double-left"></i> Pierwsza`, currentPage === 1, () => (currentPage = 1))
            );
            container.appendChild(
                createBtn(`<i class="fas fa-chevron-left"></i> Poprzednia`, currentPage === 1, () => currentPage--)
            );
            const randomBtn = document.createElement("button");
            randomBtn.innerHTML = `<i class="fas fa-random"></i> Losuj`;
            randomBtn.title = "Losuj stronę";
            randomBtn.onclick = () => {
                if (totalPages > 1) {
                    let newPage;
                    do {
                       newPage = Math.floor(Math.random() * totalPages) + 1;
                    } while (totalPages > 1 && newPage === currentPage);
                    currentPage = newPage;
                    renderGuides();
                    stopPlayAnimation();
                }
            };
            container.appendChild(randomBtn);

            const pageInput = document.createElement("input");
            pageInput.type = "number";
            pageInput.min = 1;
            pageInput.max = totalPages;
            pageInput.value = currentPage;
            pageInput.style.width = "60px";
            pageInput.onchange = (e) => {
                const newPage = parseInt(e.target.value);
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderGuides();
                    stopPlayAnimation();
                } else {
                    e.target.value = currentPage;
                }
            };
            container.appendChild(pageInput);
            const info = document.createElement("span");
            info.className = "pagination-info";
            info.innerHTML = `/ ${totalPages}`;
            container.appendChild(info);
            container.appendChild(createBtn(`Następna <i class="fas fa-chevron-right"></i>`, currentPage === totalPages, () => currentPage++));
            container.appendChild(createBtn(`Ostatnia <i class="fas fa-angle-double-right"></i>`, currentPage === totalPages, () => (currentPage = totalPages)));
            pagination.appendChild(container);
        }
        function drawRandomGuides() {
            stopPlayAnimation();
            const count = parseInt(randomSelector.value);
            if (!count) return;
            const source = filteredGuides.length > 0 ? filteredGuides : guides;
            if (source.length === 0) {
                alert("Wczytaj plik, aby wylosować pozycje!");
                randomSelector.value = "";
                return;
            }
            
            guideList.innerHTML = "";
            pagination.innerHTML = "";
            guideList.classList.add('random-draw');

            const randomGuides = [...source]
                .sort(() => 0.5 - Math.random())
                .slice(0, count);
            const animationsOn = animationState !== 0;
            randomGuides.forEach((guide, index) => {
                const div = document.createElement("div");
                div.className = "guide";
                div.innerHTML = createGuideHtml(guide);
                guideList.appendChild(div);
                if (animationsOn) {
                    div.style.opacity = 0;
                    setTimeout(() => {
                        div.classList.add("animate-in");
                        div.style.animationDelay = `${index * 0.05}s`;
                    }, 20);
                }
            });
            randomSelector.value = "";
        }


        function updatePreviewButtonUI() {
            previewBtnGroup.classList.remove("inactive", "highlighted-state");
            guideList.classList.remove("hide-covers", "only-covers");
            const previewBtnText = previewBtnMain.querySelector('.btn-text');
            const previewBtnIcon = previewBtnMain.querySelector('i');
            
            // 9. Orientation Filters UI
            const hasVertical = filteredGuides.some(g => g.orientation === 'vertical');
            const hasHorizontal = filteredGuides.some(g => g.orientation === 'horizontal');
            const showOrientationButtons = (hasVertical || hasHorizontal) && (previewState === 1 || previewState === 2);
            
            document.getElementById('previewBtn-vertical').style.display = showOrientationButtons ? 'inline-flex' : 'none';
            document.getElementById('previewBtn-horizontal').style.display = showOrientationButtons ? 'inline-flex' : 'none';
            document.getElementById('previewBtn-reset').style.display = showOrientationButtons ? 'inline-flex' : 'none';
            
            document.getElementById('previewBtn-vertical').classList.toggle('active-play', orientationFilterState === 'vertical');
            document.getElementById('previewBtn-horizontal').classList.toggle('active-play', orientationFilterState === 'horizontal');
            
            switch (previewState) {
                case 0: 
                    if(previewBtnText) previewBtnText.textContent = ` Tekst`; 
                    if(previewBtnIcon) previewBtnIcon.className = 'fas fa-align-justify';
                    previewBtnGroup.classList.add("inactive"); 
                    guideList.classList.add("hide-covers"); 
                    break;
                case 1: 
                    if(previewBtnText) previewBtnText.textContent = ` Obrazy`; 
                    if(previewBtnIcon) previewBtnIcon.className = 'fas fa-image';
                    guideList.classList.add("only-covers"); 
                    break;
                case 2: 
                    if(previewBtnText) previewBtnText.textContent = ` Wszystko`; 
                    if(previewBtnIcon) previewBtnIcon.className = 'fas fa-object-group';
                    previewBtnGroup.classList.add("highlighted-state"); 
                    break;
            }
        }

        function togglePreview() {
            if (orientationFilterState) {
                orientationFilterState = null;
            }
            previewState = (previewState + 1) % 3;
            saveToLocalStorage('view', previewState);
            renderGuides();
        }

        function resetPreview() {
            previewState = config.pageSettings.defaultView;
            orientationFilterState = null;
            saveToLocalStorage('view', previewState);
            renderGuides();
        }

        function updateAnimationButtonUI() {
            const hasAnyVideo = config.pageSettings.bgVideoEndNum > 0 && config.paths.videoBgLightUrlBase;
            const hasMultipleVideos = hasAnyVideo && (config.pageSettings.bgVideoEndNum - config.pageSettings.bgVideoStartNum > 0);
            
            const animationBtnMain = document.getElementById('animationBtn-main');
            const animationBtnPlay = document.getElementById('animationBtn-play');
            const animationBtnShuffle = document.getElementById('animationBtn-shuffle');
            const animationBtnReset = document.getElementById('animationBtn-reset');
            const animationBtnText = animationBtnMain.querySelector('.btn-text');
            const animationBtnIcon = animationBtnMain.querySelector('i');
            const lightboxAnimBtn = document.getElementById('lightbox-animationBtn');
            const lightboxVideoControls = document.getElementById('lightbox-bg-video-controls');

            animationBtn.classList.remove("inactive", "highlighted-state");
            document.body.classList.remove("no-animation");
            animationBtnPlay.style.display = 'none';
            animationBtnShuffle.style.display = 'none';
            animationBtnReset.style.display = 'none';
            lightboxVideoControls.classList.remove('visible');

            const numStates = hasAnyVideo ? 3 : 2;
            const currentAnimationState = animationState % numStates;
            
            switch (currentAnimationState) {
                case 0: 
                    if(animationBtnText) animationBtnText.textContent = ` Statycznie`; 
                    if(animationBtnIcon) animationBtnIcon.className = 'fas fa-ban';
                    if(lightboxAnimBtn) lightboxAnimBtn.innerHTML = '<i class="fas fa-ban"></i>';
                    animationBtn.classList.add("inactive"); 
                    document.body.classList.add("no-animation"); 
                    break;
                case 1: 
                    if(animationBtnText) animationBtnText.textContent = ` Animacje`;
                    if(animationBtnIcon) animationBtnIcon.className = 'fas fa-magic';
                    if(lightboxAnimBtn) lightboxAnimBtn.innerHTML = '<i class="fas fa-magic"></i>';
                    break;
                case 2:
                    if(animationBtnText) animationBtnText.textContent = ` Video`;
                    if(animationBtnIcon) animationBtnIcon.className = 'fas fa-video';
                    if(lightboxAnimBtn) lightboxAnimBtn.innerHTML = '<i class="fas fa-video"></i>';
                    animationBtn.classList.add("highlighted-state");
                    if (hasMultipleVideos) {
                        animationBtnPlay.style.display = 'inline-flex';
                        animationBtnShuffle.style.display = 'inline-flex';
                        animationBtnReset.style.display = 'inline-flex';
                        lightboxVideoControls.classList.add('visible');
                    }
                    // 3 & 7. Sync play button UI with video state
                    const isPaused = bgVideo.paused;
                    animationBtnPlay.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
                    lightboxVideoToggle.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
                    animationBtnPlay.classList.toggle('active-play', !isPaused);
                    break;
            }
        }
        
        function shuffleBackgroundVideo() {
            const { pageKey, bgVideoStartNum, bgVideoEndNum, defaultBgVideo } = config.pageSettings;
            const storageKey = `visudir_bg_video_${pageKey}`;
            const range = bgVideoEndNum - bgVideoStartNum;
            if (range < 1) return; 

            const currentVideoNum = parseInt(localStorage.getItem(storageKey)) || defaultBgVideo;
            
            let newVideoNum;
            do { newVideoNum = Math.floor(Math.random() * (range + 1)) + bgVideoStartNum; } while (newVideoNum === currentVideoNum);

            localStorage.setItem(storageKey, newVideoNum);
            initializeBackgroundVideo(currentTheme);
        }

        function changeBackgroundVideo(direction) {
            const { pageKey, bgVideoStartNum, bgVideoEndNum } = config.pageSettings;
             if (bgVideoEndNum - bgVideoStartNum < 1) return;
             if (animationState !== 2) toggleLightboxVideo();

            const storageKey = `visudir_bg_video_${pageKey}`;
            let currentVideoNum = parseInt(localStorage.getItem(storageKey)) || bgVideoStartNum;

            currentVideoNum += direction;

            if (currentVideoNum > bgVideoEndNum) currentVideoNum = bgVideoStartNum;
            if (currentVideoNum < bgVideoStartNum) currentVideoNum = bgVideoEndNum;
            
            localStorage.setItem(storageKey, currentVideoNum);
            initializeBackgroundVideo(currentTheme);
        }

        function toggleAutoShuffle() {
            if (animationState !== 2) return;
            const mainShuffleBtn = document.getElementById('animationBtn-shuffle');
            
            if (autoShuffleInterval) {
                clearInterval(autoShuffleInterval);
                autoShuffleInterval = null;
                mainShuffleBtn.classList.remove('active-play');
                lightboxVideoAutoshuffle.classList.remove('active-play');
            } else {
                if(bgVideo.paused) { toggleBackgroundVideoPlayback(); } // 7. Start video if paused
                shuffleBackgroundVideo();
                autoShuffleInterval = setInterval(shuffleBackgroundVideo, 20000);
                mainShuffleBtn.classList.add('active-play');
                lightboxVideoAutoshuffle.classList.add('active-play');
            }
        }
        
        function toggleBackgroundVideoPlayback() {
            if (animationState !== 2) return;
            if (bgVideo.paused) { bgVideo.play(); } else { bgVideo.pause(); }
            // UI is updated via the 'play' and 'pause' event listeners on the video element
        }

        function toggleLightboxVideo() {
            if (animationState === 2) {
                animationState = 1;
                if(autoShuffleInterval) toggleAutoShuffle();
            } else {
                animationState = 2;
            }
            saveToLocalStorage(`animation_${config.pageSettings.pageKey}`, animationState);
            updateAnimationButtonUI();
            updateBackgroundVideoVisibility();
        }
        
        function resetVideoSettings() {
            animationState = config.pageSettings.defaultAnimation;
            saveToLocalStorage(`animation_${config.pageSettings.pageKey}`, animationState);
            const { pageKey, defaultBgVideo } = config.pageSettings;
            localStorage.setItem(`visudir_bg_video_${pageKey}`, defaultBgVideo);
            if (autoShuffleInterval) { 
                clearInterval(autoShuffleInterval);
                autoShuffleInterval = null;
                document.getElementById('animationBtn-shuffle').classList.remove('active-play');
                lightboxVideoAutoshuffle.classList.remove('active-play');
            }
            updateAnimationButtonUI();
            updateBackgroundVideoVisibility();
        }

        function toggleAnimations() {
            if (animationState === 2 && autoShuffleInterval) { toggleAutoShuffle(); }
            const hasAnyVideo = config.pageSettings.bgVideoEndNum > 0 && config.paths.videoBgLightUrlBase;
            const numStates = hasAnyVideo ? 3 : 2;
            animationState = (animationState + 1) % numStates;
            saveToLocalStorage(`animation_${config.pageSettings.pageKey}`, animationState);
            updateAnimationButtonUI();
            updateBackgroundVideoVisibility();
            if(!backdrop.classList.contains('visible')) renderGuides();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.contains("dark-mode");
            localStorage.setItem('visudir_theme', isDark ? 'light' : 'dark');
            currentTheme = initializeTheme();
            
            if (config.pageSettings.showMiniLogo && config.logoRotator.enabled) {
                const currentLogoData = config.logoRotator.logos[currentLogoIndex];
                headerLogo.src = currentTheme === 'dark' ? currentLogoData.srcDark : currentLogoData.srcLight;
            }
            
            document.querySelectorAll(".placeholder-cover").forEach((img) => {
                img.src = currentTheme === 'dark' ? "base-system/gfx/no_cover_dark.png" : "base-system/gfx/no_cover_light.png";
            });
            updateBackgroundVideoVisibility();
        }

        playButton.addEventListener('click', togglePlayAnimation);
        playCloseBtn.addEventListener('click', stopPlayAnimation);

        function togglePlayAnimation() {
            if (playAnimationTimeout || slideshowIsPlaying) stopPlayAnimation();
            else startPlayAnimation();
        }
        
        function toggleSlideshowPlayPause() {
            if(slideshowIsPlaying) {
                slideshowIsPlaying = false;
                clearTimeout(playAnimationTimeout);
                slideshowPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                slideshowPlayBtn.classList.remove('active-play');
            } else {
                if (playGuidesQueue.length < 2) return;
                slideshowIsPlaying = true;
                slideshowPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                slideshowPlayBtn.classList.add('active-play');
                scheduleNext();
            }
        }
        
        function toggleSlideshowShuffle() {
             slideshowIsRandom = !slideshowIsRandom;
             document.getElementById('slideshow-shuffle').classList.toggle('active-play', slideshowIsRandom);
        }

        function startPlayAnimation() {
            const source = filteredGuides.length > 0 ? filteredGuides : guides;
            if (source.length === 0) return alert("Brak pozycji do wyświetlenia!");
            playGuidesQueue = [...source];
            lastPlayedGuide = null;
            playCurrentIndex = 0;
            
            document.body.classList.add("play-mode-active");
            playButton.querySelector('.btn-text').textContent = ' Stop';
            
            setTimeout(() => {
                backdrop.classList.add("visible");
                updateAnimationButtonUI();
                updateBackgroundVideoVisibility();
            }, 100);
            
            slideshowIsPlaying = true;
            slideshowPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
            slideshowPlayBtn.classList.add('active-play');

            scheduleNext();
        }

        function stopPlayAnimation() {
            if (playAnimationTimeout) clearTimeout(playAnimationTimeout);
            playAnimationTimeout = null;
            slideshowIsPlaying = false;
            
            document.body.classList.remove("play-mode-active");
            backdrop.classList.remove("visible", "preview-active");
            playGuideContainer.innerHTML = "";
            if (playCaption) playCaption.innerHTML = "";
            slideshowPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
            slideshowPlayBtn.classList.remove('active-play');
            if(playButton) {
                const btnText = playButton.querySelector('.btn-text');
                if(btnText) btnText.textContent = ' Play';
            }
            updateBackgroundVideoVisibility();
        }

        function scheduleNext(isNav = false) {
             if (playAnimationTimeout) clearTimeout(playAnimationTimeout);
             if(!isNav && !slideshowIsPlaying) return;

             let guide;
             if (playGuidesQueue.length < 2) {
                guide = playGuidesQueue[0];
            } else {
                do {
                    if (slideshowIsRandom && !isNav) {
                         playCurrentIndex = Math.floor(Math.random() * playGuidesQueue.length)
                    } else if (!isNav) {
                        playCurrentIndex = (playCurrentIndex + 1) % playGuidesQueue.length;
                    }
                    guide = playGuidesQueue[playCurrentIndex];
                } while (playGuidesQueue.length > 1 && guide === lastPlayedGuide && slideshowIsRandom);
            }
            if (!guide) return;
            lastPlayedGuide = guide;
            displayRandomGuide(guide);
        }
        
        function preloadNextGuide() {
            if (!slideshowIsPlaying || playGuidesQueue.length < 2) return;
            let nextIndex = (playCurrentIndex + 1) % playGuidesQueue.length;
            const nextGuide = playGuidesQueue[nextIndex];
            if (!nextGuide) return;
            const baseFilename = nextGuide.file.split("$$")[0].replace(/\.(pdf|epub|mobi|link|jpg|png|mp4|avi)$/i, "");
            const hdPath = config.paths.previewHdFolderName ? `${config.paths.previewHdFolderName}/${encodeURIComponent(baseFilename)}.jpg` : null;
            if (hdPath) { (new Image()).src = hdPath; }
        }

        function displayRandomGuide(guide) {
            const container = playGuideContainer;
            const existingContent = container.firstChild;

            const showNewGuide = () => {
                container.innerHTML = "";
                const fallbackCover = document.documentElement.classList.contains("dark-mode") ? "base-system/gfx/no_cover_dark.png" : "base-system/gfx/no_cover_light.png";
                
                const baseFilename = guide.file.split("$$")[0].replace(/\.(pdf|epub|mobi|link|jpg|png|mp4|avi)$/i, "");
                const hdPath = config.paths.previewHdFolderName ? `${config.paths.previewHdFolderName}/${encodeURIComponent(baseFilename)}.jpg` : null;
                const sdPath = `${config.paths.coversFolderName}/${encodeURIComponent(baseFilename)}.jpg`;
                const directMediaPath = `${config.paths.dataFolderName}/${encodeURIComponent(guide.file)}`;
                
                const isVideo = ['mp4', 'avi'].includes(guide.format);
                const displayElement = document.createElement(isVideo ? 'video' : 'img');
                
                if (isVideo) {
                    displayElement.src = directMediaPath;
                    displayElement.controls = true;
                    displayElement.autoplay = true;
                    displayElement.onerror = () => { displayElement.poster = sdPath; displayElement.onerror = () => { displayElement.poster = fallbackCover; displayElement.onerror = null; }; };
                } else if (['jpg', 'png', 'gif'].includes(guide.format)) {
                    displayElement.src = directMediaPath;
                    displayElement.onerror = () => { if (hdPath) displayElement.src = hdPath; displayElement.onerror = () => { displayElement.src = sdPath; displayElement.onerror = () => { displayElement.src = fallbackCover; displayElement.onerror = null; }; }; };
                } else if (hdPath) {
                    displayElement.src = hdPath;
                    displayElement.onerror = () => { displayElement.src = sdPath; displayElement.onerror = () => { displayElement.src = fallbackCover; displayElement.onerror = null; }; };
                } else {
                    displayElement.src = sdPath;
                    displayElement.onerror = () => { displayElement.src = fallbackCover; displayElement.onerror = null; };
                }

                const link = document.createElement('a');
                if (guide.format === 'link') {
                    const targetUrl = decodeUrlFromFilename(guide.file);
                    link.href = targetUrl;
                    if (!targetUrl.startsWith('.') && !targetUrl.startsWith('/')) { link.target = '_blank'; link.rel = 'noopener noreferrer'; }
                } else {
                    const fileUrl = `${config.paths.dataFolderName}/${encodeURIComponent(guide.file)}`;
                    link.href = fileUrl;
                    if (guide.format === 'pdf' || isVideo) { link.target = '_blank'; link.rel = 'noopener noreferrer'; } else { link.download = guide.file; }
                }
                link.appendChild(displayElement);
                container.appendChild(link);
                
                const currentIndexInQueue = playGuidesQueue.indexOf(guide);
                const counterText = playGuidesQueue.length > 1 ? `<b>${currentIndexInQueue + 1}</b> / ${playGuidesQueue.length}` : '';
                const descriptionText = guide.linkData.description || "";
                let titleText = guide.title;
                if (/^\d{2}\s*/.test(titleText)) titleText = titleText.replace(/^\d{2}\s*/, "");
                
                playCaption.innerHTML = `<div class="caption-title-highlight">${counterText} ${titleText}</div><div class="caption-description">${descriptionText}</div>`;
                
                if (slideshowIsPlaying && !isVideo) {
                    preloadNextGuide();
                    playAnimationTimeout = setTimeout(()=> scheduleNext(), 4000);
                }
            };

            if (existingContent) {
                if (playAnimationTimeout) clearTimeout(playAnimationTimeout);
                
                const mediaElement = existingContent.querySelector ? existingContent.querySelector('img, video') : existingContent;
                if(mediaElement && !document.body.classList.contains('no-animation')) {
                     mediaElement.style.animation = 'zoomOutImage 0.5s ease-in forwards';
                }
                const timeout = document.body.classList.contains('no-animation') ? 0 : 500;
                setTimeout(showNewGuide, timeout);
            } else {
                showNewGuide();
            }
        }

        // 5. Renamed from showImagePreview to handle videos
        function showMediaPreview(guideFilename) {
            stopPlayAnimation();
            backdrop.classList.add("visible", "preview-active");

            const guideFormat = getFileExtension(guideFilename);
            const isVideo = ['mp4', 'avi'].includes(guideFormat);

            const baseFilename = guideFilename.split("$$")[0].replace(/\.(jpg|png|mp4|avi)$/i, "");
            const hdPath = config.paths.previewHdFolderName ? `${config.paths.previewHdFolderName}/${encodeURIComponent(baseFilename)}.jpg` : null;
            const directPath = `${config.paths.dataFolderName}/${encodeURIComponent(guideFilename)}`;
            const fallbackCover = document.documentElement.classList.contains("dark-mode") ? "base-system/gfx/no_cover_dark.png" : "base-system/gfx/no_cover_light.png";

            const mediaElement = document.createElement(isVideo ? 'video' : 'img');
            mediaElement.className = "preview-media";
            
            if (isVideo) {
                mediaElement.src = directPath;
                mediaElement.controls = true;
                mediaElement.autoplay = true;
            } else {
                mediaElement.alt = "Podgląd obrazu";
                if (hdPath) {
                    mediaElement.src = hdPath;
                    mediaElement.onerror = () => { mediaElement.src = directPath; mediaElement.onerror = () => { mediaElement.src = fallbackCover; mediaElement.onerror = null; }; };
                } else {
                    mediaElement.src = directPath;
                    mediaElement.onerror = () => { mediaElement.src = fallbackCover; mediaElement.onerror = null; };
                }
            }

            const link = document.createElement('a');
            link.href = directPath;
            link.target = '_blank';
            link.appendChild(mediaElement);

            playGuideContainer.innerHTML = "";
            playGuideContainer.appendChild(link);
            playCaption.innerHTML = "";
            document.getElementById('lightbox-controls').style.display = 'none';
            document.getElementById('lightbox-minimizeBtn').style.display = 'none';

            const close = () => {
                backdrop.classList.remove("visible", "preview-active");
                playGuideContainer.innerHTML = "";
                document.getElementById('lightbox-controls').style.display = 'flex';
                document.getElementById('lightbox-minimizeBtn').style.display = 'flex';
            };
            const backdropClose = (e) => { if (e.target === backdrop) close(); };

            playCloseBtn.addEventListener("click", close, { once: true });
            backdrop.addEventListener("click", backdropClose, { once: true });
        }
        
        function setupLightboxListeners() {
            document.getElementById('lightbox-animationBtn').addEventListener('click', toggleAnimations);
            document.getElementById('lightbox-darkModeBtn').addEventListener('click', toggleDarkMode);
            
            document.getElementById('slideshow-play').addEventListener('click', toggleSlideshowPlayPause);
            document.getElementById('slideshow-shuffle').addEventListener('click', toggleSlideshowShuffle);
            document.getElementById('slideshow-stop').addEventListener('click', stopPlayAnimation);
            document.getElementById('slideshow-next').addEventListener('click', () => { playCurrentIndex = (playCurrentIndex + 1) % playGuidesQueue.length; scheduleNext(true); });
            document.getElementById('slideshow-prev').addEventListener('click', () => { playCurrentIndex = (playCurrentIndex - 1 + playGuidesQueue.length) % playGuidesQueue.length; scheduleNext(true); });
            document.getElementById('slideshow-first').addEventListener('click', () => { playCurrentIndex = 0; scheduleNext(true); });
            document.getElementById('slideshow-last').addEventListener('click', () => { playCurrentIndex = playGuidesQueue.length - 1; scheduleNext(true); });
            
            lightboxVideoToggle.addEventListener('click', toggleBackgroundVideoPlayback);
            lightboxVideoAutoshuffle.addEventListener('click', toggleAutoShuffle);
            document.getElementById('lightbox-video-next').addEventListener('click', () => changeBackgroundVideo(1));
            document.getElementById('lightbox-video-prev').addEventListener('click', () => changeBackgroundVideo(-1));
        }
        setupLightboxListeners();

        backdrop.addEventListener("click", (e) => {
            if (e.target === backdrop && !backdrop.classList.contains('preview-active')) stopPlayAnimation();
        });
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        const debouncedUpdatePagination = debounce(updatePaginationOptions, 250);
        window.addEventListener("resize", debouncedUpdatePagination);
        window.addEventListener("pageshow", function(event) {
            if (event.persisted) {
                applyFilters();
                updatePaginationOptions();
                renderGuides();
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            [".top-header", ".controls", ".pagination", ".footer"].forEach(
                (sel, i) => {
                    const el = document.querySelector(sel);
                    if (el) {
                        el.style.animationDelay = `${0.2 + i * 0.2}s`;
                        el.classList.add( i < 2 ? "animated-header" : "animated-pagination");
                    }
                }
            );
             // 3 & 7: Add event listeners to sync video state with UI
            bgVideo.addEventListener('play', updateAnimationButtonUI);
            bgVideo.addEventListener('pause', updateAnimationButtonUI);
        });
        searchInput.addEventListener("input", () => {
            currentPage = 1;
            renderGuides();
            stopPlayAnimation();
        });
        formatFilter.addEventListener("change", () => {
            currentPage = 1;
            const value = formatFilter.value;
            orientationFilterState = null;
            if (value.startsWith("search:")) {
                searchInput.value = value.substring(7);
            } else {
                saveToLocalStorage('format', value);
            }
            renderGuides();
            stopPlayAnimation();
        });
        sortSelector.addEventListener("change", (e) => {
            if (e.target.value) {
                applySort(e.target.value, guides);
                saveToLocalStorage('sort', e.target.value);
                currentPage = 1;
                renderGuides();
            }
            e.target.value = "";
        });
        itemsPerPageSelector.addEventListener("change", (e) => {
            if(!e.target.value) return;
            selectedRowCount = parseInt(e.target.value);
            saveToLocalStorage('rows', selectedRowCount);
            itemsPerPage = selectedRowCount * itemsPerRow;
            currentPage = 1;
            renderGuides();
            stopPlayAnimation();
        });
        randomSelector.addEventListener("change", drawRandomGuides);
        fileInput.addEventListener("change", function () {
            if (this.files[0]) {
                loadAndParseFile(this.files[0]);
                stopPlayAnimation();
            }
        });
    </script>
</body>

</html>